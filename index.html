<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPPT Training Plan Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Dark Mode (Default) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #cbd5e1; /* slate-300 */
            background-image: radial-gradient(circle at top right, rgba(14, 165, 233, 0.2), transparent 40%),
                              radial-gradient(circle at bottom left, rgba(139, 92, 246, 0.2), transparent 50%);
            background-attachment: fixed;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .glass-container {
            background-color: rgba(30, 41, 59, 0.5); /* slate-800 with opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .loader {
            position: relative;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .loader::before, .loader::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            animation: bubble 2.5s infinite ease-in-out;
            filter: blur(5px);
        }

        .loader::before {
            width: 100%;
            height: 100%;
            background-image: linear-gradient(45deg, #38bdf8, #818cf8);
        }

        .loader::after {
            width: 70%;
            height: 70%;
            background-image: linear-gradient(-45deg, #a78bfa, #c084fc);
            animation-delay: -0.6s;
        }

        @keyframes bubble {
            0%, 100% {
                transform: scale(0.7);
                opacity: 0.5;
            }
            50% {
                transform: scale(1);
                opacity: 0.8;
            }
        }
        
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Light Mode Styles */
        body.light-mode {
            background-color: #f1f5f9; /* slate-100 */
            color: #1e293b; /* slate-800 */
            background-image: none;
        }
        .light-mode .glass-container {
            background-color: rgba(255, 255, 255, 0.8); /* white with opacity */
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .light-mode .text-slate-300 { color: #1e293b; }
        .light-mode .text-slate-400, .light-mode .text-slate-500 { color: #475569; }
        .light-mode .border-slate-700 { border-color: #e2e8f0; }
        .light-mode .bg-slate-800\/50 { background-color: #f8fafc; }
        .light-mode .border-slate-600 { border-color: #cbd5e1; }
        .light-mode .text-slate-100 { color: #0f172a; }
        .light-mode #add-attempt-btn { background-color: #e0f2fe; color: #0c4a6e; border-color: #bae6fd; }
        .light-mode #add-attempt-btn:hover { background-color: #bae6fd; }
        .light-mode .bg-slate-700\/50 { background-color: #f1f5f9; }
        .light-mode .points-span, .light-mode .text-sky-300, .light-mode .text-sky-400 { color: #0284c7; }
        .light-mode .bg-red-500\/20 { background-color: #fee2e2; color: #b91c1c; }
        .light-mode .bg-yellow-500\/20 { background-color: #fef9c3; color: #a16207; }
        .light-mode .bg-slate-500\/20 { background-color: #e2e8f0; color: #475569; }
        .light-mode .bg-green-500\/20 { background-color: #dcfce7; color: #166534; }
        .light-mode .bg-cyan-500\/20 { background-color: #cffafe; color: #0e7490; }
        .light-mode .bg-indigo-500\/10 { background-color: #e0e7ff; }
        .light-mode .bg-sky-500\/10 { background-color: #e0f2fe; }
        .light-mode .prose { color: #334155; }
        .light-mode .prose-strong, .light-mode .prose-headings { color: #1e293b; }
        .light-mode .bg-slate-900\/50 { background-color: #f8fafc; }
        .light-mode h1.bg-clip-text { background-image: linear-gradient(to right, #38bdf8, #818cf8); }
        .light-mode input::placeholder { color: #94a3b8; }
        .light-mode select { color: #1e293b; }
        .light-mode .delete-attempt-btn { color: #94a3b8; }
        .light-mode .delete-attempt-btn:hover { color: #dc2626; }
        .light-mode .file\:bg-sky-500\/20 { background-color: #e0f2fe; }
        .light-mode .file\:text-sky-300 { color: #0c4a6e; }
        .light-mode .hover\:file\:bg-sky-500\/30:hover { background-color: #bae6fd; }
        .light-mode ::-webkit-scrollbar-track { background: #e2e8f0; }
        .light-mode ::-webkit-scrollbar-thumb { background: #94a3b8; }
        .light-mode ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        #theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 50;
        }
    </style>
</head>
<body class="text-slate-300">

    <div id="theme-toggle" class="cursor-pointer p-2 rounded-full transition-colors hover:bg-slate-500/20">
        <!-- Sun Icon -->
        <svg id="theme-toggle-light-icon" class="w-6 h-6 text-yellow-300 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM10 16a1 1 0 100 2 1 1 0 000-2zm-8-5a1 1 0 100 2h1a1 1 0 100-2H2zm8-7a1 1 0 00-1 1v1a1 1 0 102 0V3a1 1 0 00-1-1zM4.05 15.357a1 1 0 101.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zM2.93 4.343a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414z"></path></svg>
        <!-- Moon Icon -->
        <svg id="theme-toggle-dark-icon" class="w-6 h-6 text-slate-400 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
    </div>

    <div class="container mx-auto max-w-4xl p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-sky-400 to-violet-500 text-transparent bg-clip-text">IPPT Training Plan Generator</h1>
            <p class="mt-2 text-slate-400">Enter your details and past results to get a customized AI-powered training plan.</p>
        </header>

        <main class="glass-container p-6 sm:p-8 rounded-2xl shadow-2xl space-y-8">
            <!-- Section 1: Officer's Details -->
            <section id="officer-details">
                <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                    <h2 class="text-xl font-semibold text-slate-100">1. Officer's Details</h2>
                    <button id="clear-all-btn" class="text-sm text-sky-400 hover:underline">Clear All</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-slate-300">Name</label>
                        <input type="text" id="name" class="mt-1 block w-full rounded-md bg-slate-800/50 border-slate-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., John Doe">
                    </div>
                    <div>
                        <label for="age" class="block text-sm font-medium text-slate-300">Age</label>
                        <input type="number" id="age" class="mt-1 block w-full rounded-md bg-slate-800/50 border-slate-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., 25">
                        <p id="age-group-display" class="text-xs text-slate-400 mt-1">Age Group: --</p>
                    </div>
                    <div class="md:col-span-2">
                        <label for="gender" class="block text-sm font-medium text-slate-300">Gender</label>
                        <select id="gender" class="mt-1 block w-full rounded-md bg-slate-800/50 border-slate-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                         <label for="target-goal" class="block text-sm font-medium text-slate-300">Target Goal</label>
                         <select id="target-goal" class="mt-1 block w-full rounded-md bg-slate-800/50 border-slate-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <option value="" disabled selected>Select a target award</option>
                            <option value="Pass">Pass</option>
                            <option value="Silver">Silver</option>
                            <option value="Gold">Gold</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                         <label for="medical-fitness" class="block text-sm font-medium text-slate-300">Medical Fitness Status / PES</label>
                         <input type="text" id="medical-fitness" class="mt-1 block w-full rounded-md bg-slate-800/50 border-slate-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" value="None">
                    </div>
                </div>
            </section>

            <!-- Section 2: IPPT Attempts -->
            <section id="ippt-attempts">
                <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                    <h2 class="text-xl font-semibold text-slate-100">2. IPPT Attempts</h2>
                </div>
                <div id="attempts-container" class="space-y-4">
                    <!-- Dynamic attempt rows will be injected here -->
                </div>
                 <p id="no-attempts-msg" class="text-center text-slate-400 p-4 border-2 border-dashed border-slate-600 rounded-lg mt-4">Click the button below to add an IPPT attempt.</p>
            
                <div class="mt-4">
                    <button id="add-attempt-btn" class="w-full flex items-center justify-center gap-2 bg-sky-500/20 hover:bg-sky-500/30 text-sky-300 font-semibold py-2 px-4 rounded-lg transition-colors duration-200 ease-in-out border border-sky-500/30">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        <span id="add-attempt-btn-text">Add First Attempt</span>
                    </button>
                </div>
                 <div id="weakness-analysis-section" class="hidden mt-6 text-center">
                    <div class="flex flex-wrap justify-center gap-4">
                        <button id="analyze-weakness-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                            âœ¨ Analyze Weaknesses
                        </button>
                        <button id="export-excel-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 flex items-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Export to Excel
                        </button>
                    </div>
                    <div id="weakness-output" class="mt-4 text-left p-4 bg-indigo-500/10 rounded-lg min-h-[50px]"></div>
                </div>
            </section>

            <!-- Section 3: Generate Plan -->
            <section id="generate-section" class="pt-4 text-center">
                 <div class="mb-6 text-left">
                    <label for="api-key" class="block text-sm font-medium text-slate-300">Google AI API Key</label>
                    <input type="password" id="api-key" class="mt-1 block w-full rounded-md bg-slate-800/50 border-slate-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Enter your API key here">
                    <p class="mt-1 text-xs text-slate-500">You need a free key to generate the plan. Get yours from <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 hover:underline">Google AI Studio</a>.</p>
                </div>
                <button id="generate-plan-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 ease-in-out transform hover:-translate-y-0.5 w-full md:w-auto">
                    Generate Training Plan
                </button>
                <div id="generation-status" class="mt-4 min-h-[50px] flex justify-center items-center"></div>
            </section>
            
            <!-- Section 4: Output -->
            <section id="output-section" class="hidden">
                 <h2 class="text-xl font-semibold text-slate-100 mb-4 border-b border-slate-700 pb-2">Your Personalised Training Plan</h2>
                 <div id="plan-output" class="prose max-w-none prose-slate mt-4 p-4 bg-slate-900/50 rounded-lg text-slate-300 prose-strong:text-slate-100 prose-headings:text-slate-200">
                     <!-- AI generated plan will be displayed here -->
                 </div>
                 <div id="dietary-section" class="mt-6 text-center">
                     <button id="dietary-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                        âœ¨ Get Dietary Tips
                    </button>
                    <div id="dietary-output" class="mt-4 text-left p-4 bg-sky-500/10 rounded-lg min-h-[50px] hidden"></div>
                 </div>
            </section>
        </main>

        <footer class="text-center mt-8 text-sm text-slate-500">
            <p>IPPT Training Plan Generator &copy; 2024. For training guidance only.</p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const nameEl = document.getElementById('name');
        const ageEl = document.getElementById('age');
        const genderEl = document.getElementById('gender');
        const medicalFitnessEl = document.getElementById('medical-fitness');
        const addAttemptBtn = document.getElementById('add-attempt-btn');
        const attemptsContainer = document.getElementById('attempts-container');
        const generatePlanBtn = document.getElementById('generate-plan-btn');
        const generationStatusEl = document.getElementById('generation-status');
        const outputSectionEl = document.getElementById('output-section');
        const planOutputEl = document.getElementById('plan-output');
        const noAttemptsMsg = document.getElementById('no-attempts-msg');
        const apiKeyEl = document.getElementById('api-key');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const weaknessAnalysisSection = document.getElementById('weakness-analysis-section');
        const analyzeWeaknessBtn = document.getElementById('analyze-weakness-btn');
        const weaknessOutput = document.getElementById('weakness-output');
        const dietaryBtn = document.getElementById('dietary-btn');
        const dietaryOutput = document.getElementById('dietary-output');
        const addAttemptBtnText = document.getElementById('add-attempt-btn-text');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const targetGoalEl = document.getElementById('target-goal');
        const ageGroupDisplayEl = document.getElementById('age-group-display');
        const themeToggle = document.getElementById('theme-toggle');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        
        // --- IPPT SCORING ENGINE (ACCURATE AS PER OFFICIAL CHARTS) ---
        const CHARTS = {
            male: {
                // Data transcribed from user-provided 'Men-pushup-score.xlsx'
                pushups: {"1":[0,0,0,0,0,0,0,0,0,0,0,0,0,1],"2":[0,0,0,0,0,0,0,0,0,0,0,0,1,2],"3":[0,0,0,0,0,0,0,0,0,0,0,1,2,4],"4":[0,0,0,0,0,0,0,0,0,0,1,2,4,6],"5":[0,0,0,0,0,0,0,0,0,1,2,4,6,8],"6":[0,0,0,0,0,0,0,0,1,2,4,6,8,9],"7":[0,0,0,0,0,0,0,1,2,4,6,8,9,10],"8":[0,0,0,0,0,0,1,2,4,6,8,9,10,11],"9":[0,0,0,0,0,1,2,4,6,8,9,10,11,12],"10":[0,0,0,0,1,2,4,6,8,9,10,11,12,13],"11":[0,0,0,1,2,4,6,8,9,10,11,12,13,14],"12":[0,0,1,2,4,6,8,9,10,11,12,13,14,15],"13":[0,1,2,4,6,8,9,10,11,12,13,14,15,15],"14":[1,2,4,6,8,9,10,11,12,13,14,15,15,16],"15":[2,4,6,8,9,10,11,12,13,14,15,15,16,16],"16":[4,6,8,9,10,11,12,13,14,15,15,16,16,16],"17":[6,8,9,10,11,12,13,14,15,15,16,16,16,17],"18":[8,9,10,11,12,13,14,15,15,16,16,16,17,17],"19":[9,10,11,12,13,14,15,15,16,16,16,17,17,17],"20":[10,11,12,13,14,15,15,16,16,16,17,17,17,18],"21":[11,12,13,14,15,15,16,16,16,17,17,17,18,18],"22":[12,13,14,15,15,16,16,16,17,17,17,18,18,18],"23":[13,14,15,15,16,16,16,17,17,17,18,18,18,19],"24":[14,15,15,16,16,16,17,17,17,18,18,18,19,19],"25":[15,15,16,16,16,17,17,17,18,18,18,19,19,19],"26":[15,16,16,16,17,17,17,18,18,18,19,19,19,20],"27":[16,16,16,17,17,17,18,18,18,19,19,19,20,20],"28":[16,16,17,17,17,18,18,18,19,19,19,20,20,21],"29":[16,17,17,17,18,18,18,19,19,19,20,20,21,21],"30":[17,17,17,18,18,18,19,19,19,20,20,20,21,22],"31":[17,17,18,18,18,19,19,19,20,20,20,21,21,22],"32":[17,18,18,18,19,19,19,20,20,20,21,21,22,22],"33":[18,18,18,19,19,19,20,20,20,21,21,21,22,23],"34":[18,18,19,19,19,20,20,20,21,21,21,22,22,23],"35":[18,19,19,19,20,20,20,20,21,21,22,22,23,23],"36":[19,19,19,20,20,20,20,21,21,22,22,22,23,24],"37":[19,19,20,20,20,20,21,21,21,22,22,23,23,24],"38":[19,20,20,20,20,21,21,21,22,22,23,23,24,24],"39":[20,20,20,20,21,21,21,21,22,22,23,23,24,25],"40":[20,20,20,21,21,21,21,22,22,23,23,24,24,25],"41":[20,20,21,21,21,21,22,22,22,23,23,24,25,25],"42":[20,21,21,21,21,22,22,22,23,23,24,24,25,25],"43":[21,21,21,21,22,22,22,22,23,23,24,24,25,25],"44":[21,21,21,22,22,22,22,23,23,24,24,25,25,25],"45":[21,21,22,22,22,22,23,23,23,24,24,25,25,25],"46":[21,22,22,22,22,23,23,23,24,24,25,25,25,25],"47":[22,22,22,22,23,23,23,23,24,24,25,25,25,25],"48":[22,22,22,23,23,23,23,24,24,25,25,25,25,25],"49":[22,22,23,23,23,23,24,24,24,25,25,25,25,25],"50":[22,23,23,23,23,24,24,24,25,25,25,25,25,25],"51":[23,23,23,23,24,24,24,24,25,25,25,25,25,25],"52":[23,23,23,24,24,24,24,25,25,25,25,25,25,25],"53":[23,23,24,24,24,24,25,25,25,25,25,25,25,25],"54":[23,24,24,24,24,25,25,25,25,25,25,25,25,25],"55":[24,24,24,24,25,25,25,25,25,25,25,25,25,25],"56":[24,24,24,25,25,25,25,25,25,25,25,25,25,25],"57":[24,24,25,25,25,25,25,25,25,25,25,25,25,25],"58":[24,25,25,25,25,25,25,25,25,25,25,25,25,25],"59":[25,25,25,25,25,25,25,25,25,25,25,25,25,25],"60":[25,25,25,25,25,25,25,25,25,25,25,25,25,25]},
                // Data transcribed from user-provided 'Men-situp-score.xlsx'
                situps: {"1":[0,0,0,0,0,0,0,0,0,0,0,0,0,0],"2":[0,0,0,0,0,0,0,0,0,0,0,0,0,1],"3":[0,0,0,0,0,0,0,0,0,0,0,0,1,2],"4":[0,0,0,0,0,0,0,0,0,0,0,1,2,3],"5":[0,0,0,0,0,0,0,0,0,0,1,2,3,4],"6":[0,0,0,0,0,0,0,0,0,1,2,3,4,5],"7":[0,0,0,0,0,0,0,0,1,2,3,4,5,6],"8":[0,0,0,0,0,0,0,1,2,3,4,5,6,6],"9":[0,0,0,0,0,0,1,2,3,4,5,6,6,7],"10":[0,0,0,0,0,1,2,3,4,5,6,6,7,7],"11":[0,0,0,0,1,2,3,4,5,6,6,7,7,8],"12":[0,0,0,1,2,3,4,5,6,6,7,7,8,9],"13":[0,0,1,2,3,4,5,6,6,7,7,8,9,10],"14":[0,1,2,3,4,5,6,6,7,7,8,9,10,11],"15":[1,2,3,4,5,6,6,7,7,8,9,10,11,12],"16":[2,3,4,5,6,6,7,7,8,9,10,11,12,13],"17":[3,4,5,6,6,7,7,8,9,10,11,12,13,13],"18":[4,5,6,6,7,7,8,9,10,11,12,13,13,14],"19":[5,6,6,7,7,8,9,10,11,12,13,13,14,14],"20":[6,6,7,7,8,9,10,11,12,13,13,14,14,15],"21":[6,7,7,8,9,10,11,12,13,13,14,14,15,16],"22":[7,7,8,9,10,11,12,13,13,14,14,15,16,17],"23":[7,8,9,10,11,12,13,13,14,14,15,16,17,18],"24":[8,9,10,11,12,13,13,14,14,15,16,17,18,18],"25":[9,10,11,12,13,13,14,14,15,16,17,18,18,19],"26":[10,11,12,13,13,14,14,15,16,17,18,18,19,19],"27":[11,12,13,13,14,14,15,16,17,18,18,19,19,20],"28":[12,13,13,14,14,15,16,17,18,18,19,19,20,20],"29":[13,13,14,14,15,16,17,18,18,19,19,20,20,20],"30":[13,14,14,15,16,17,18,18,19,19,20,20,20,21],"31":[14,14,15,16,17,18,18,19,19,20,20,20,21,21],"32":[14,15,16,17,18,18,19,19,20,20,20,21,21,21],"33":[15,16,17,18,18,19,19,20,20,20,21,21,21,22],"34":[16,17,18,18,19,19,20,20,20,21,21,21,22,22],"35":[17,18,18,19,19,20,20,20,21,21,21,22,22,22],"36":[18,18,19,19,20,20,20,20,21,21,22,22,22,23],"37":[18,19,19,20,20,20,20,21,21,22,22,22,23,23],"38":[19,19,20,20,20,20,21,21,21,22,22,23,23,23],"39":[19,20,20,20,20,21,21,21,22,22,22,23,23,24],"40":[20,20,20,20,21,21,21,21,22,22,23,23,24,24],"41":[20,20,20,21,21,21,21,22,22,23,23,23,24,24],"42":[20,20,21,21,21,21,22,22,22,23,23,24,24,25],"43":[20,21,21,21,21,22,22,22,23,23,23,24,24,25],"44":[21,21,21,21,22,22,22,22,23,23,24,24,25,25],"45":[21,21,21,22,22,22,22,23,23,24,24,24,25,25],"46":[21,21,22,22,22,22,23,23,23,24,24,25,25,25],"47":[21,22,22,22,22,23,23,23,24,24,24,25,25,25],"48":[22,22,22,22,23,23,23,23,24,24,25,25,25,25],"49":[22,22,22,23,23,23,23,24,24,25,25,25,25,25],"50":[22,22,23,23,23,23,24,24,24,25,25,25,25,25],"51":[22,23,23,23,23,24,24,24,25,25,25,25,25,25],"52":[23,23,23,23,24,24,24,24,25,25,25,25,25,25],"53":[23,23,23,24,24,24,24,25,25,25,25,25,25,25],"54":[23,23,24,24,24,24,25,25,25,25,25,25,25,25],"55":[23,24,24,24,24,25,25,25,25,25,25,25,25,25],"56":[24,24,24,24,25,25,25,25,25,25,25,25,25,25],"57":[24,24,24,25,25,25,25,25,25,25,25,25,25,25],"58":[24,24,25,25,25,25,25,25,25,25,25,25,25,25],"59":[24,25,25,25,25,25,25,25,25,25,25,25,25,25],"60":[25,25,25,25,25,25,25,25,25,25,25,25,25,25]},
                // Data transcribed from user-provided 'Men-running-score.xlsx'
                run: {"8:30":[50,50,50,50,50,50,50,50,50,50,50,50,50,50],"8:40":[49,50,50,50,50,50,50,50,50,50,50,50,50,50],"8:50":[48,49,50,50,50,50,50,50,50,50,50,50,50,50],"9:00":[47,48,49,50,50,50,50,50,50,50,50,50,50,50],"9:10":[46,47,48,50,50,50,50,50,50,50,50,50,50,50],"9:20":[45,46,47,49,50,50,50,50,50,50,50,50,50,50],"9:30":[44,45,46,48,49,50,50,50,50,50,50,50,50,50],"9:40":[43,44,45,47,48,49,50,50,50,50,50,50,50,50],"9:50":[42,43,44,46,47,48,49,50,50,50,50,50,50,50],"10:00":[41,42,43,45,46,47,48,49,50,50,50,50,50,50],"10:10":[40,41,42,44,45,46,47,48,49,50,50,50,50,50],"10:20":[39,40,41,43,44,45,46,47,48,49,50,50,50,50],"10:30":[38,39,40,42,43,44,45,46,47,48,49,50,50,50],"10:40":[38,38,39,41,42,43,44,45,46,47,48,49,50,50],"10:50":[37,37,38,40,41,42,43,44,45,46,47,48,49,50],"11:00":[37,37,37,39,40,41,42,43,44,45,46,47,48,49],"11:10":[36,36,37,38,39,40,41,42,43,44,45,46,47,48],"11:20":[36,36,36,37,38,39,40,41,42,43,44,45,46,47],"11:30":[35,35,36,37,38,38,39,40,41,42,43,44,45,46],"11:40":[35,35,35,36,37,37,38,39,40,41,42,43,44,45],"11:50":[34,34,35,35,36,36,37,38,39,40,41,42,43,44],"12:00":[33,34,34,35,36,36,37,38,39,40,41,42,43,43],"12:10":[32,33,34,35,36,36,37,38,38,39,40,41,42,42],"12:20":[31,32,33,34,35,36,36,37,38,38,39,40,41,42],"12:30":[30,31,32,34,35,35,36,37,37,38,38,39,40,41],"12:40":[29,30,31,33,34,35,35,36,36,37,37,38,38,39],"12:50":[28,29,30,32,33,34,35,35,36,36,37,37,38,38],"13:00":[27,28,29,31,32,33,34,35,35,36,36,37,37,38],"13:10":[26,27,28,30,31,32,33,34,35,35,36,36,37,37],"13:20":[25,26,27,29,30,31,32,33,34,35,35,36,36,37],"13:30":[24,25,26,28,29,30,31,32,33,34,35,35,36,36],"13:40":[23,24,25,27,28,29,30,31,32,33,34,35,35,36],"13:50":[22,23,24,26,27,28,29,30,31,32,33,34,35,35],"14:00":[21,22,23,25,26,27,28,29,30,31,32,33,34,34],"14:10":[20,21,22,24,25,26,27,28,29,30,31,32,33,33],"14:20":[19,20,21,23,24,25,26,27,28,29,30,31,32,32],"14:30":[18,19,20,22,23,24,25,26,27,28,29,30,31,31],"14:40":[16,18,19,21,22,23,24,25,26,27,28,29,30,30],"14:50":[14,16,18,20,21,22,23,24,25,26,27,28,29,30],"15:00":[12,14,16,19,20,21,22,23,24,25,26,27,28,28],"15:10":[10,12,14,18,19,20,21,22,23,24,25,26,27,28],"15:20":[8,10,12,16,18,19,20,21,22,23,24,25,26,27],"15:30":[6,8,10,14,16,18,19,20,21,22,23,24,25,26],"15:40":[4,6,8,12,14,16,18,19,20,21,22,23,24,25],"15:50":[2,4,6,10,12,14,16,18,19,20,21,22,23,24],"16:00":[1,2,4,8,10,12,14,16,18,19,20,21,22,23],"16:10":[0,1,2,6,8,10,12,14,16,18,19,20,21,22],"16:20":[0,0,1,4,6,8,10,12,14,16,18,19,20,21],"16:30":[0,0,0,2,4,6,8,10,12,14,16,18,19,20],"16:40":[0,0,0,1,2,4,6,8,10,12,14,16,18,19],"16:50":[0,0,0,0,1,2,4,6,8,10,12,14,16,18],"17:00":[0,0,0,0,0,1,2,4,6,8,10,12,14,16],"17:10":[0,0,0,0,0,0,1,2,4,6,8,10,12,14],"17:20":[0,0,0,0,0,0,0,1,2,4,6,8,10,12],"17:30":[0,0,0,0,0,0,0,0,1,2,4,6,8,10],"17:40":[0,0,0,0,0,0,0,0,0,1,2,4,6,8],"17:50":[0,0,0,0,0,0,0,0,0,0,1,2,4,6],"18:00":[0,0,0,0,0,0,0,0,0,0,0,1,2,4],"18:10":[0,0,0,0,0,0,0,0,0,0,0,0,1,2],"18:20":[0,0,0,0,0,0,0,0,0,0,0,0,0,1]}
            },
            female: { 
                //Data for female pushups
                pushups: {"1":[0,0,0,0,0,0,0,0,0,0,0,0,0,0],"2":[0,0,0,0,0,0,0,0,0,0,0,0,0,1],"3":[0,0,0,0,0,0,0,0,0,0,0,0,1,5],"4":[0,0,0,0,0,0,0,0,0,0,0,1,5,10],"5":[0,0,0,0,0,0,0,0,0,0,1,5,10,15],"6":[0,0,0,0,0,0,0,0,0,1,5,10,15,15],"7":[0,0,0,0,0,0,0,0,1,5,10,15,15,16],"8":[0,0,0,0,0,0,0,1,5,10,15,15,16,17],"9":[0,0,0,0,0,0,1,5,10,15,15,16,17,18],"10":[0,0,0,0,0,1,5,10,15,15,16,17,18,18],"11":[0,0,0,0,1,5,10,15,15,16,17,18,18,19],"12":[0,0,0,1,5,10,15,15,16,17,18,18,19,19],"13":[0,0,1,5,10,15,15,16,17,18,18,19,19,20],"14":[0,1,5,10,15,15,16,17,18,19,19,19,20,20],"15":[1,5,10,15,15,16,17,18,18,19,19,20,20,21],"16":[5,10,15,15,16,17,18,18,19,19,20,20,21,21],"17":[10,15,15,16,17,18,18,18,19,20,20,21,21,22],"18":[15,15,16,17,18,18,18,19,19,20,21,21,22,22],"19":[15,16,17,18,18,18,19,19,20,20,21,22,22,23],"20":[16,17,18,18,18,19,19,19,20,21,22,22,23,23],"21":[17,18,18,18,19,19,19,20,20,21,22,23,23,24],"22":[18,18,18,19,19,19,20,20,21,21,22,23,24,24],"23":[18,18,19,19,19,20,20,20,21,22,23,24,24,25],"24":[18,19,19,19,20,20,20,21,21,22,23,24,25,25],"25":[19,19,19,20,20,21,21,21,22,22,23,25,25,25],"26":[19,19,20,20,20,21,21,21,22,23,24,25,25,25],"27":[19,20,20,20,21,21,21,22,22,23,24,25,25,25],"28":[20,20,20,21,21,21,22,22,23,23,24,25,25,25],"29":[20,20,20,21,21,22,22,22,23,24,25,25,25,25],"30":[20,20,21,21,22,22,22,23,23,24,25,25,25,25],"31":[20,20,21,21,22,22,23,23,24,24,25,25,25,25],"32":[20,21,21,22,22,23,23,23,24,25,25,25,25,25],"33":[21,21,21,22,22,23,23,24,24,25,25,25,25,25],"34":[21,21,22,22,23,23,24,24,25,25,25,25,25,25],"35":[21,21,22,22,23,23,24,24,25,25,25,25,25,25],"36":[21,22,22,23,23,24,24,25,25,25,25,25,25,25],"37":[22,22,22,23,23,24,24,25,25,25,25,25,25,25],"38":[22,22,23,23,24,24,25,25,25,25,25,25,25,25],"39":[22,22,23,23,24,24,25,25,25,25,25,25,25,25],"40":[22,23,23,24,24,25,25,25,25,25,25,25,25,25],"41":[23,23,23,24,24,25,25,25,25,25,25,25,25,25],"42":[23,23,24,24,25,25,25,25,25,25,25,25,25,25],"43":[23,23,24,24,25,25,25,25,25,25,25,25,25,25],"44":[23,24,24,25,25,25,25,25,25,25,25,25,25,25],"45":[24,24,24,25,25,25,25,25,25,25,25,25,25,25],"46":[24,24,25,25,25,25,25,25,25,25,25,25,25,25],"47":[24,24,25,25,25,25,25,25,25,25,25,25,25,25],"48":[24,25,25,25,25,25,25,25,25,25,25,25,25,25],"49":[24,25,25,25,25,25,25,25,25,25,25,25,25,25],"50":[25,25,25,25,25,25,25,25,25,25,25,25,25,25]},
                //Data for female situps
                situps: {"1":[0,0,0,0,0,0,0,0,0,0,0,0,0,0],"2":[0,0,0,0,0,0,0,0,0,0,0,0,0,1],"3":[0,0,0,0,0,0,0,0,0,0,0,0,1,2],"4":[0,0,0,0,0,0,0,0,0,0,0,1,2,4],"5":[0,0,0,0,0,0,0,0,0,0,1,2,4,6],"6":[0,0,0,0,0,0,0,0,0,1,2,4,6,8],"7":[0,0,0,0,0,0,0,0,1,2,4,6,8,10],"8":[0,0,0,0,0,0,0,1,2,4,6,8,10,11],"9":[0,0,0,0,0,0,1,2,4,6,8,10,11,12],"10":[0,0,0,0,0,1,2,4,6,8,10,11,12,13],"11":[0,0,0,0,1,2,4,6,8,10,11,12,13,14],"12":[0,0,0,1,2,4,6,8,10,11,12,13,14,15],"13":[0,0,1,2,4,6,8,10,11,12,13,14,15,15],"14":[0,1,2,4,6,8,10,11,12,13,14,15,15,16],"15":[1,2,4,6,8,10,11,12,13,14,15,15,16,16],"16":[2,4,6,8,10,11,12,13,14,15,15,16,16,17],"17":[4,6,8,10,11,12,13,14,15,15,16,16,17,18],"18":[6,8,10,11,12,13,14,15,15,16,16,17,18,18],"19":[8,10,11,12,13,14,15,15,16,16,17,18,18,19],"20":[10,11,12,13,14,15,15,16,16,17,18,18,19,19],"21":[11,12,13,14,15,15,16,16,17,18,18,19,19,20],"22":[12,13,14,15,15,16,16,17,18,18,19,19,20,21],"23":[13,14,15,15,16,16,17,18,18,19,19,20,21,22],"24":[14,15,15,16,16,17,18,18,19,19,20,21,22,23],"25":[15,15,16,16,17,18,18,19,19,20,21,22,23,23],"26":[15,16,16,17,18,18,19,19,20,20,22,23,23,24],"27":[16,16,17,18,18,19,19,20,20,21,23,23,24,24],"28":[16,17,18,18,19,19,20,20,21,21,23,24,24,25],"29":[17,18,18,19,19,20,20,21,21,22,24,24,25,25],"30":[18,18,19,19,20,20,21,21,22,22,24,25,25,25],"31":[18,18,19,20,20,21,21,22,22,23,25,25,25,25],"32":[18,19,19,20,21,21,22,22,23,23,25,25,25,25],"33":[19,19,20,20,21,22,22,23,23,24,25,25,25,25],"34":[19,19,20,21,22,22,23,23,24,24,25,25,25,25],"35":[19,20,20,21,22,23,23,23,24,25,25,25,25,25],"36":[20,20,21,21,22,23,23,24,24,25,25,25,25,25],"37":[20,20,21,22,23,23,24,24,25,25,25,25,25,25],"38":[20,21,21,22,23,24,24,24,25,25,25,25,25,25],"39":[21,21,22,22,23,24,24,25,25,25,25,25,25,25],"40":[21,21,22,23,24,24,25,25,25,25,25,25,25,25],"41":[21,22,22,23,24,25,25,25,25,25,25,25,25,25],"42":[22,22,23,23,24,25,25,25,25,25,25,25,25,25],"43":[22,22,23,24,25,25,25,25,25,25,25,25,25,25],"44":[22,23,23,24,25,25,25,25,25,25,25,25,25,25],"45":[23,23,24,24,25,25,25,25,25,25,25,25,25,25],"46":[23,23,24,25,25,25,25,25,25,25,25,25,25,25],"47":[23,24,24,25,25,25,25,25,25,25,25,25,25,25],"48":[24,24,25,25,25,25,25,25,25,25,25,25,25,25],"49":[24,24,25,25,25,25,25,25,25,25,25,25,25,25],"50":[24,25,25,25,25,25,25,25,25,25,25,25,25,25],"51":[24,25,25,25,25,25,25,25,25,25,25,25,25,25],"52":[25,25,25,25,25,25,25,25,25,25,25,25,25,25]},
                //Data for female run
                run: {"21:40":[0,0,0,0,0,0,0,0,0,0,1,2,4,6],"21:30":[0,0,0,0,0,0,0,0,0,1,2,4,6,8],"21:20":[0,0,0,0,0,0,0,0,1,2,4,6,8,10],"21:10":[0,0,0,0,0,0,0,1,2,4,6,8,10,12],"21:00":[0,0,0,0,0,0,1,2,4,6,8,10,12,14],"20:50":[0,0,0,0,0,1,2,4,6,8,10,12,14,16],"20:40":[0,0,0,0,1,2,4,6,8,10,12,14,16,18],"20:30":[0,0,0,1,2,4,6,8,10,12,14,16,18,20],"20:20":[0,0,1,2,4,6,8,10,12,14,16,18,20,21],"20:10":[0,1,2,4,6,8,10,12,14,16,18,20,21,22],"20:00":[1,2,4,6,8,10,12,14,16,18,20,21,22,23],"19:50":[2,4,6,8,10,12,14,16,18,20,21,22,23,24],"19:40":[4,6,8,10,12,14,16,18,20,21,22,23,24,25],"19:30":[6,8,10,12,14,16,18,20,21,22,23,24,25,26],"19:20":[8,10,12,14,16,18,20,21,22,23,24,25,26,27],"19:10":[10,12,14,16,18,20,21,22,23,24,25,26,27,28],"19:00":[12,14,16,18,20,21,22,23,24,25,26,27,28,29],"18:50":[14,16,18,20,21,22,23,24,25,26,27,28,29,30],"18:40":[16,18,20,21,22,23,24,25,26,27,28,29,30,30],"18:30":[18,20,21,22,23,24,25,26,27,28,29,30,30,31],"18:20":[20,21,22,23,24,25,26,27,28,29,30,30,31,31],"18:10":[21,22,23,24,25,26,27,28,29,30,30,31,31,32],"18:00":[22,23,24,25,26,27,28,29,30,30,31,31,32,32],"17:50":[23,24,25,26,27,28,29,30,30,31,31,32,32,33],"17:40":[24,25,26,27,28,29,30,30,31,31,32,32,33,33],"17:30":[25,26,27,28,29,30,30,31,31,32,32,33,33,34],"17:20":[26,27,28,29,30,30,31,31,32,32,33,33,34,34],"17:10":[27,28,29,30,30,31,31,32,32,33,33,34,34,35],"17:00":[28,29,30,30,31,31,32,32,33,33,34,34,35,35],"16:50":[29,30,30,31,31,32,32,33,33,34,34,35,35,35],"16:40":[30,30,31,31,32,32,33,33,34,34,35,35,35,36],"16:30":[30,31,31,32,32,33,33,34,34,35,35,35,36,36],"16:20":[31,31,32,32,33,33,34,34,35,35,35,36,36,36],"16:10":[31,32,32,33,33,34,34,35,35,35,36,36,36,37],"16:00":[32,32,33,33,34,34,35,35,35,36,36,36,37,37],"15:50":[32,33,33,34,34,35,35,35,36,36,36,37,37,37],"15:40":[33,33,34,34,35,35,35,36,36,36,37,37,37,38],"15:30":[33,34,34,35,35,35,36,36,36,37,37,37,38,38],"15:20":[34,34,35,35,35,36,36,36,37,37,37,38,38,38],"15:10":[34,35,35,35,36,36,36,37,37,37,38,38,38,39],"15:00":[35,35,35,36,36,36,37,37,37,38,38,38,39,39],"14:50":[35,35,36,36,36,37,37,37,38,38,38,39,39,41],"14:40":[35,36,36,36,37,37,37,38,38,38,39,39,41,41],"14:30":[36,36,36,37,37,37,38,38,38,39,39,41,41,42],"14:20":[36,36,37,37,37,38,38,38,39,39,41,41,42,42],"14:10":[36,37,37,37,38,38,38,39,39,41,41,42,42,43],"14:00":[37,37,37,38,38,38,39,39,41,41,42,42,43,43],"13:50":[37,37,38,38,38,39,39,41,41,42,42,43,43,44],"13:40":[37,38,38,38,39,39,41,41,42,42,43,43,44,44],"13:30":[38,38,38,39,39,41,41,42,42,43,43,44,44,45],"13:20":[38,38,39,39,41,41,42,42,43,43,44,44,45,46],"13:10":[38,39,39,41,41,42,42,43,43,44,44,45,45,46],"13:00":[39,39,41,41,42,42,43,43,44,44,45,45,46,46],"12:50":[39,41,41,42,42,43,43,44,44,45,45,46,46,47],"12:40":[41,41,42,42,43,43,44,44,45,45,46,46,47,48],"12:30":[41,42,42,43,43,44,44,45,45,46,46,47,48,49],"12:20":[42,42,43,43,44,44,45,45,46,46,47,48,49,50],"12:10":[42,43,43,44,44,45,45,46,46,47,48,49,50,50],"12:00":[43,43,44,44,45,45,46,46,47,48,49,50,50,50],"11:50":[43,44,44,45,45,46,46,47,48,49,50,50,50,50],"11:40":[44,44,45,45,46,46,47,48,49,50,50,50,50,50],"11:30":[44,45,45,46,46,47,48,49,50,50,50,50,50,50],"11:20":[45,45,46,46,47,48,49,50,50,50,50,50,50,50],"11:10":[45,46,46,47,48,49,50,50,50,50,50,50,50,50],"11:00":[46,46,47,48,49,50,50,50,50,50,50,50,50,50],"10:50":[46,47,48,49,50,50,50,50,50,50,50,50,50,50],"10:40":[47,48,49,50,50,50,50,50,50,50,50,50,50,50],"10:30":[47,49,50,50,50,50,50,50,50,50,50,50,50,50],"10:20":[48,50,50,50,50,50,50,50,50,50,50,50,50,50],"10:10":[49,50,50,50,50,50,50,50,50,50,50,50,50,50],"10:00":[50,50,50,50,50,50,50,50,50,50,50,50,50,50]}
            }
        };

        function getAgeGroupIndex(age) {
            if (age <= 21) return 0;
            if (age >= 22 && age <= 24) return 1;
            if (age >= 25 && age <= 27) return 2;
            if (age >= 28 && age <= 30) return 3;
            if (age >= 31 && age <= 33) return 4;
            if (age >= 34 && age <= 36) return 5;
            if (age >= 37 && age <= 39) return 6;
            if (age >= 40 && age <= 42) return 7;
            if (age >= 43 && age <= 45) return 8;
            if (age >= 46 && age <= 48) return 9;
            if (age >= 49 && age <= 51) return 10;
            if (age >= 52 && age <= 54) return 11;
            if (age >= 55 && age <= 57) return 12;
            if (age >= 58 && age <= 60) return 13;
            return 13; 
        }

        function getStationScore(reps, age, gender, station) {
            if (gender === 'male') {
                if (station === 'pushups' && reps > 60) reps = 60;
                if (station === 'situps' && reps > 60) reps = 60;
            } else if (gender === 'female') {
                if (station === 'pushups' && reps > 50) reps = 50;
                if (station === 'situps' && reps > 52) reps = 52;
            }

            const chart = CHARTS[gender][station];
            const ageIndex = getAgeGroupIndex(age);
            if (!chart[reps]) return 0;
            const score = chart[reps][ageIndex];
            return score === undefined || score < 0 ? 0 : score;
        }

        function getRunScore(totalSeconds, age, gender) {
            const chart = CHARTS[gender].run;
            const timeBrackets = Object.keys(chart).sort((a, b) => {
                const aSecs = parseInt(a.split(':')[0]) * 60 + parseInt(a.split(':')[1]);
                const bSecs = parseInt(b.split(':')[0]) * 60 + parseInt(b.split(':')[1]);
                return aSecs - bSecs;
            });

            for (const timeStr of timeBrackets) {
                const bracketSecs = parseInt(timeStr.split(':')[0]) * 60 + parseInt(timeStr.split(':')[1]);
                if (totalSeconds <= bracketSecs) {
                    const ageIndex = getAgeGroupIndex(age);
                    const score = chart[timeStr][ageIndex];
                    return score === undefined || score < 0 ? 0 : score;
                }
            }
            return 0;
        }
        
        function calculateIpptResult(pushups, situps, runTime, age, gender) {
             if (!age || age <= 0) {
                 return { award: "Enter Age", awardClass: "bg-gray-500/20 text-gray-300", totalPoints: 0, pushupPoints: 0, situpPoints: 0, runPoints: 0 };
            }
            
            const [minutes, seconds] = runTime.split(':').map(Number);
            const totalSeconds = (minutes * 60) + (isNaN(seconds) ? 0 : seconds);
            
            const pushupPoints = getStationScore(pushups, age, gender, 'pushups');
            const situpPoints = getStationScore(situps, age, gender, 'situps');
            const runPoints = /^\d{1,2}:\d{2}$/.test(runTime) ? getRunScore(totalSeconds, age, gender) : 0;

            const totalPoints = pushupPoints + situpPoints + runPoints;
            
            let passThreshold = 61, silverThreshold = 75, goldThreshold = 85;
            
            let award = "Fail", awardClass = "bg-red-500/20 text-red-300";
            if(pushupPoints >= 1 && situps >= 1 && runPoints >= 1 && totalPoints >= 51) { // Base pass requirement
                if (totalPoints >= goldThreshold) { award = "Gold"; awardClass = "bg-yellow-500/20 text-yellow-300"; } 
                else if (totalPoints >= silverThreshold) { award = "Silver"; awardClass = "bg-slate-500/20 text-slate-300"; } 
                else if (totalPoints >= passThreshold) { award = "Pass"; awardClass = "bg-green-500/20 text-green-300"; }
            }
            
            return { award, awardClass, totalPoints, pushupPoints, situpPoints, runPoints };
        }

        function createAttemptRow(id) {
            const attemptDiv = document.createElement('div');
            attemptDiv.className = 'attempt-row grid grid-cols-1 md:grid-cols-10 gap-4 items-start bg-slate-700/50 p-3 rounded-lg';
            attemptDiv.dataset.id = id;
            attemptDiv.innerHTML = `
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-400">Push-ups</label>
                    <input type="number" class="mt-1 pushups-input w-full rounded-md bg-slate-800/50 border-slate-600 shadow-sm text-sm" placeholder="Reps">
                    <span class="text-xs text-sky-400 points-span pushup-points">Points: --</span>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-400">Sit-ups</label>
                    <input type="number" class="mt-1 situps-input w-full rounded-md bg-slate-800/50 border-slate-600 shadow-sm text-sm" placeholder="Reps">
                    <span class="text-xs text-sky-400 points-span situp-points">Points: --</span>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-400">2.4km Run</label>
                    <input type="text" class="mt-1 run-input w-full rounded-md bg-slate-800/50 border-slate-600 shadow-sm text-sm" placeholder="mm:ss">
                    <span class="text-xs text-sky-400 points-span run-points">Points: --</span>
                </div>
                <div class="md:col-span-3 flex flex-col items-center justify-center text-center h-full pt-4 md:pt-0">
                    <span class="block text-xs font-medium text-slate-500 mb-1">Result</span>
                    <span class="result-span inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-semibold">---</span>
                </div>
                <div class="md:col-span-1 flex items-center justify-center h-full">
                    <button class="delete-attempt-btn text-slate-500 hover:text-red-500 transition-colors p-2 rounded-full mt-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>`;
            
            const updateTrigger = () => updateResult(attemptDiv);
            attemptDiv.querySelectorAll('input').forEach(input => input.addEventListener('input', updateTrigger));
            
            const deleteBtn = attemptDiv.querySelector('.delete-attempt-btn');
            deleteBtn.addEventListener('click', () => {
                attemptDiv.remove();
                if (attemptsContainer.children.length === 0) {
                    noAttemptsMsg.classList.remove('hidden');
                    weaknessAnalysisSection.classList.add('hidden');
                }
            });

            return attemptDiv;
        }

        function updateResult(attemptDiv) {
            const pushups = parseInt(attemptDiv.querySelector('.pushups-input').value) || 0;
            const situps = parseInt(attemptDiv.querySelector('.situps-input').value) || 0;
            const runTime = attemptDiv.querySelector('.run-input').value;
            const age = parseInt(ageEl.value);
            const gender = genderEl.value;
            const resultSpan = attemptDiv.querySelector('.result-span');
            
            const pushupPointsSpan = attemptDiv.querySelector('.pushup-points');
            const situpPointsSpan = attemptDiv.querySelector('.situp-points');
            const runPointsSpan = attemptDiv.querySelector('.run-points');

            const resetPoints = () => {
                pushupPointsSpan.textContent = 'Points: --';
                situpPointsSpan.textContent = 'Points: --';
                runPointsSpan.textContent = 'Points: --';
            };

            if (!age || age <= 0) {
                resultSpan.textContent = `Enter Age`;
                resultSpan.className = `result-span inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-semibold bg-gray-500/20 text-gray-300`;
                resetPoints();
                return;
            }

            const { award, awardClass, totalPoints, pushupPoints, situpPoints, runPoints } = calculateIpptResult(pushups, situps, runTime, age, gender);
            
            pushupPointsSpan.textContent = `Points: ${pushupPoints}`;
            situpPointsSpan.textContent = `Points: ${situpPoints}`;
            runPointsSpan.textContent = `Points: ${runPoints}`;

            if (/^\d{1,2}:\d{2}$/.test(runTime) && pushups >= 0 && situps >= 0) {
                resultSpan.textContent = `${award} (${totalPoints} pts)`;
                resultSpan.className = `result-span inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-semibold ${awardClass}`;
            } else {
                resultSpan.textContent = '---';
                resultSpan.className = 'result-span inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-semibold';
            }
        }
        
        // --- Gemini API Call Helper ---
        async function callGemini(prompt, outputEl, buttonEl, loadingMessages = []) {
            const apiKey = apiKeyEl.value;
            if (!apiKey) {
                const target = buttonEl.id === 'generate-plan-btn' ? generationStatusEl : outputEl;
                target.innerHTML = `<span class="text-red-400 font-semibold">Please enter your Google AI API Key to proceed.</span>`;
                apiKeyEl.focus();
                return null;
            }
            
            let messageInterval;
            if (buttonEl) {
                buttonEl.disabled = true;
                buttonEl.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            if (loadingMessages.length > 0) {
                let messageIndex = 0;
                const updateMessage = () => {
                    outputEl.innerHTML = `<div class="flex flex-col justify-center items-center"><div class="loader"></div><p class="mt-2 text-sky-300">${loadingMessages[messageIndex]}</p></div>`;
                    messageIndex = (messageIndex + 1) % loadingMessages.length;
                };
                updateMessage();
                messageInterval = setInterval(updateMessage, 2500);
            } else {
                 outputEl.innerHTML = '<div class="flex justify-center items-center"><div class="loader"></div></div>';
            }


            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData?.error?.message || `API Error: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error('No content received from AI.');

                outputEl.innerHTML = simpleMarkdownToHtml(text);
                return text; 

            } catch (error) {
                console.error("Gemini API Error:", error);
                outputEl.innerHTML = `<span class="text-red-400 font-semibold">Error: ${error.message}</span>`;
                return null;
            } finally {
                if(messageInterval) clearInterval(messageInterval);
                if (buttonEl) {
                    buttonEl.disabled = false;
                    buttonEl.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }
        
        // --- Data Gathering ---
        function getOfficerData() {
            const officerData = {
                name: nameEl.value,
                age: ageEl.value,
                gender: genderEl.value,
                medicalStatus: medicalFitnessEl.value,
                targetGoal: targetGoalEl.value,
                attempts: []
            };
            document.querySelectorAll('.attempt-row').forEach((row, index) => {
                officerData.attempts.push({
                    attempt: index + 1,
                    pushups: row.querySelector('.pushups-input').value,
                    situps: row.querySelector('.situps-input').value,
                    runTime: row.querySelector('.run-input').value,
                    result: row.querySelector('.result-span').textContent
                });
            });
            return officerData;
        }

        // --- Feature Functions ---
        function exportToExcel() {
            const officerData = getOfficerData();
            if (officerData.attempts.length === 0) {
                return;
            }

            const ws_data = [
                ["Officer's Details"],
                ["Name", officerData.name],
                ["Age", officerData.age],
                ["Gender", officerData.gender],
                ["Medical Status", officerData.medicalStatus],
                [],
                ["IPPT Attempts"]
            ];

            const headers = ["Attempt #", "Push-ups", "Sit-ups", "2.4km Run", "Result"];
            ws_data.push(headers);

            officerData.attempts.forEach(attempt => {
                ws_data.push([
                    attempt.attempt,
                    attempt.pushups,
                    attempt.situps,
                    attempt.runTime,
                    attempt.result
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            ws['!cols'] = [ {wch:15}, {wch:15}, {wch:15}, {wch:15}, {wch:30} ];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "IPPT Attempts");
            const fileName = `${officerData.name.replace(/\s+/g, '_') || 'Officer'}_IPPT_Attempts.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        async function analyzeWeakness() {
            const officerData = getOfficerData();
            if (officerData.attempts.length === 0) return;

            let prompt = `You are a friendly and encouraging fitness buddy! ðŸ¤¸â€â™‚ï¸ Analyze the following IPPT results for an officer named ${officerData.name}. In simple terms, point out their weakest station based on the points. Use emoticons to make your one-paragraph explanation fun and motivating.
            
            Results:
            ${officerData.attempts.map(att => `- Push-ups: ${att.pushups}, Sit-ups: ${att.situps}, 2.4km Run: ${att.runTime} (Result: ${att.result})`).join('\n')}
            
            Keep the analysis concise and encouraging.`;

            await callGemini(prompt, weaknessOutput, analyzeWeaknessBtn);
        }

        async function generatePlan() {
            if (!nameEl.value || !ageEl.value || !medicalFitnessEl.value || !targetGoalEl.value || attemptsContainer.children.length === 0) {
                generationStatusEl.innerHTML = `<span class="text-red-400 font-semibold">Please fill in all details including Name, Age, Target Goal, Medical Status, and add at least one IPPT attempt.</span>`;
                return;
            }
             if (parseInt(ageEl.value) <=0) {
                generationStatusEl.innerHTML = `<span class="text-red-400 font-semibold">Please enter a valid age.</span>`;
                return;
            }
            
            outputSectionEl.classList.add('hidden');
            dietaryOutput.classList.add('hidden');

            const officerData = getOfficerData();
            let prompt = `You are a super motivating and friendly fitness buddy! ðŸ’ª Your goal is to create a simple and fun 4-week IPPT training plan for an officer. Use simple language and lots of encouraging emoticons (like ðŸ‘, ðŸŽ‰, ðŸ”¥). Make the plan easy to understand and follow.
                
                Officer's Details:
                - Name: ${officerData.name}, Age: ${officerData.age}, Gender: ${officerData.gender}, Medical Status: ${officerData.medicalStatus}
                - TARGET GOAL: Achieve IPPT ${officerData.targetGoal}
                
                Past IPPT Attempts:
                ${officerData.attempts.map(att => `- Push-ups: ${att.pushups}, Sit-ups: ${att.situps}, 2.4km Run: ${att.runTime} (${att.result})`).join('\n')}

                Your response must be a detailed, encouraging, and actionable 4-week plan focused on bridging the gap from their current results to their ${officerData.targetGoal} target. Include:
                1. A brief, encouraging opening statement acknowledging their goal.
                2. An analysis of their weakest stations in the context of their goal.
                3. A week-by-week schedule (Week 1-4) with specific, progressively challenging exercises (sets, reps, distances) and 2-3 rest days per week.
                4. Tips on proper form.
                5. If medical status indicates limitations (e.g., 'excused running'), suggest alternatives.
                6. Format using Markdown (headings, bold, bullets).`;
            
            const loadingMessages = [
                "Hold on... ðŸƒâ€â™‚ï¸",
                "Millions of computers are working on this... ðŸ’»",
                "We're almost there, but not yet... ðŸ¤”",
                "Almost... âœ¨"
            ];

            const planText = await callGemini(prompt, generationStatusEl, generatePlanBtn, loadingMessages);
            
            if(planText) {
                planOutputEl.innerHTML = simpleMarkdownToHtml(planText);
                outputSectionEl.classList.remove('hidden');
                generationStatusEl.innerHTML = '<span class="text-green-400 font-semibold">Your plan is ready! âœ…</span>';
            }
        }
        
        async function getDietaryAdvice() {
            dietaryOutput.classList.remove('hidden');
            const officerData = getOfficerData();
            let prompt = `You are a friendly food coach! ðŸ¥‘ Your goal is to give 5 simple and easy-to-follow dietary tips for an officer in Singapore who wants to improve their IPPT score. Use simple words and fun emoticons (like ðŸŽ, ðŸ¥¦, ðŸ’§). Make the advice practical and mention some yummy local food choices.
            
            Officer's Details:
            - Age: ${officerData.age}
            
            Generate 5 simple, actionable dietary tips to support their training. Do not create a full meal plan. Format as a bulleted list using Markdown.`;

            await callGemini(prompt, dietaryOutput, dietaryBtn);
        }
        
        // --- UI and Event Listeners ---
        function simpleMarkdownToHtml(md) {
            return md.replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>').replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mt-6 mb-3 border-b pb-1 border-slate-700">$1</h2>').replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mt-8 mb-4">$1</h1>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/^\s*-\s(.*$)/gim, '<li class="ml-4">$1</li>').replace(/<\/li>\n<li/g, '</li><li').replace(/(<li.*?>[\s\S]*?<\/li>)/g, '<ul>$1</ul>').replace(/<\/ul>\s*<ul>/g, '').replace(/\n/g, '<br>');
        }
        
        const fullRecalculateTrigger = () => {
            document.querySelectorAll('.attempt-row').forEach(row => updateResult(row));
        }

        const updateAgeGroupDisplay = () => {
            const age = parseInt(ageEl.value);
            if(age > 0) {
                ageGroupDisplayEl.textContent = `Age Group: ${getAgeGroupIndex(age) + 1}`;
            } else {
                ageGroupDisplayEl.textContent = 'Age Group: --';
            }
        };

        let attemptCount = 0;
        addAttemptBtn.addEventListener('click', () => {
            attemptCount++;
            const newRow = createAttemptRow(attemptCount);
            attemptsContainer.appendChild(newRow);
            noAttemptsMsg.classList.add('hidden');
            weaknessAnalysisSection.classList.remove('hidden');
            addAttemptBtnText.textContent = 'Add Another Attempt';
        });
        
        clearAllBtn.addEventListener('click', () => {
            nameEl.value = '';
            ageEl.value = '';
            genderEl.value = 'male';
            medicalFitnessEl.value = 'None';
            targetGoalEl.value = '';
            
            attemptsContainer.innerHTML = '';
            attemptCount = 0;
            noAttemptsMsg.classList.remove('hidden');
            outputSectionEl.classList.add('hidden');
            weaknessAnalysisSection.classList.add('hidden');
            weaknessOutput.innerHTML = '';
            dietaryOutput.innerHTML = '';
            generationStatusEl.innerHTML = '';
            addAttemptBtnText.textContent = 'Add First Attempt';
            updateAgeGroupDisplay();
        });

        generatePlanBtn.addEventListener('click', generatePlan);
        analyzeWeaknessBtn.addEventListener('click', analyzeWeakness);
        dietaryBtn.addEventListener('click', getDietaryAdvice);
        exportExcelBtn.addEventListener('click', exportToExcel);
        
        // --- Theme Toggle Logic ---
        const applyTheme = (theme) => {
            if (theme === 'light') {
                document.body.classList.add('light-mode');
                darkIcon.classList.remove('hidden');
                lightIcon.classList.add('hidden');
            } else {
                document.body.classList.remove('light-mode');
                darkIcon.classList.add('hidden');
                lightIcon.classList.remove('hidden');
            }
        };

        const savedTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(savedTheme);

        themeToggle.addEventListener('click', () => {
            const currentTheme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        // Attaching global listeners once
        ageEl.addEventListener('input', () => {
            updateAgeGroupDisplay();
            fullRecalculateTrigger();
        });
        genderEl.addEventListener('change', fullRecalculateTrigger);
    </script>
</body>
</html>
